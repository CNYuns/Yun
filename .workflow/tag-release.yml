version: '1.0'
name: tag-release
displayName: Tagå‘å¸ƒæµæ°´çº¿

# ä»…åœ¨æ¨é€tagæ—¶è§¦å‘
triggers:
  push:
    tags:
      include:
        - v*.*.*

stages:
  # é˜¶æ®µ1ï¼šæ„å»ºå¹¶æ‰“åŒ…å„å¹³å°ç‰ˆæœ¬
  - stage:
      name: build_and_package
      displayName: ç¼–è¯‘å¹¶æ‰“åŒ…
      steps:
        - step: build@golang
          name: build_releases
          displayName: Goç¼–è¯‘æ‰“åŒ…
          # Goç‰ˆæœ¬ï¼ˆä½¿ç”¨1.24ï¼‰
          golangVersion: '1.24'
          commands: |
            #!/bin/bash
            set -e

            echo "===== é…ç½®Goç¯å¢ƒ ====="
            # å¼ºåˆ¶ä½¿ç”¨å›½å†…é•œåƒ
            export GOPROXY=https://goproxy.cn,https://goproxy.io
            export GOSUMDB=sum.golang.google.cn
            export GO111MODULE=on
            export GONOPROXY=""
            export GONOSUMDB=""
            export GOPRIVATE=""

            echo "Go version:"
            go version
            echo "GOPROXY: $GOPROXY"

            # è¯»å–ç‰ˆæœ¬å·
            VERSION=$(cat config/version | tr -d '\n\r')
            echo "Building Yun Panel v$VERSION"

            echo "===== å¼€å§‹æ„å»º ====="

            # æ„å»ºLinux amd64
            echo "Building Linux amd64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=readonly -ldflags "-w -s" -trimpath -o yun main.go
            mkdir -p yun-linux-amd64
            cp yun yun-linux-amd64/
            cp yun.service yun-linux-amd64/ || true
            cp yun.sh yun-linux-amd64/ || true
            tar -czf yun-linux-amd64.tar.gz yun-linux-amd64/
            rm -rf yun-linux-amd64 yun
            echo "âœ“ Linux amd64: yun-linux-amd64.tar.gz"

            # æ„å»ºLinux arm64
            echo "Building Linux arm64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -mod=readonly -ldflags "-w -s" -trimpath -o yun main.go
            mkdir -p yun-linux-arm64
            cp yun yun-linux-arm64/
            cp yun.service yun-linux-arm64/ || true
            cp yun.sh yun-linux-arm64/ || true
            tar -czf yun-linux-arm64.tar.gz yun-linux-arm64/
            rm -rf yun-linux-arm64 yun
            echo "âœ“ Linux arm64: yun-linux-arm64.tar.gz"

            # æ„å»ºWindows amd64
            echo "Building Windows amd64..."
            CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -mod=readonly -ldflags "-w -s" -trimpath -o yun.exe main.go
            mkdir -p yun-windows-amd64
            cp yun.exe yun-windows-amd64/
            cd yun-windows-amd64 && zip -r ../yun-windows-amd64.zip . && cd ..
            rm -rf yun-windows-amd64 yun.exe
            echo "âœ“ Windows amd64: yun-windows-amd64.zip"

            # æ„å»ºWindows 386
            echo "Building Windows 386..."
            CGO_ENABLED=0 GOOS=windows GOARCH=386 go build -mod=readonly -ldflags "-w -s" -trimpath -o yun.exe main.go
            mkdir -p yun-windows-386
            cp yun.exe yun-windows-386/
            cd yun-windows-386 && zip -r ../yun-windows-386.zip . && cd ..
            rm -rf yun-windows-386 yun.exe
            echo "âœ“ Windows 386: yun-windows-386.zip"

            echo "===== æ„å»ºå®Œæˆ ====="
            echo "ç”Ÿæˆçš„å‘å¸ƒæ–‡ä»¶ï¼š"
            ls -lh *.tar.gz *.zip

          # ä¿å­˜æ„å»ºäº§ç‰©ï¼ˆåœ¨å½“å‰ç›®å½•ï¼‰
          artifacts:
            - name: BUILD_ARTIFACT
              path:
                - ./yun-linux-amd64.tar.gz
                - ./yun-linux-arm64.tar.gz
                - ./yun-windows-amd64.zip
                - ./yun-windows-386.zip

  # é˜¶æ®µ2ï¼šä¸Šä¼ åˆ°Release
  - stage:
      name: release
      displayName: å‘å¸ƒåˆ°Release
      steps:
        - step: publish@release_artifacts
          name: upload_release
          displayName: ä¸Šä¼ åˆ°Gitee Release
          # ä½¿ç”¨æ„å»ºé˜¶æ®µçš„äº§ç‰©
          dependArtifact: BUILD_ARTIFACT
          # ä½¿ç”¨Gitæ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
          version: '${GIT_TAG}'
          # Releaseè¯´æ˜
          releaseNote: |
            ## Yun Panel ${GIT_TAG}

            è‡ªåŠ¨æ„å»ºçš„å¤šå¹³å°å‘å¸ƒç‰ˆæœ¬ã€‚

            ### ğŸ“¦ æ”¯æŒçš„å¹³å°

            **Linux:**
            - amd64 (x86_64) - é€‚ç”¨äºå¤§å¤šæ•°LinuxæœåŠ¡å™¨
            - arm64 (aarch64) - é€‚ç”¨äºARMæ¶æ„æœåŠ¡å™¨

            **Windows:**
            - amd64 (64ä½) - é€‚ç”¨äº64ä½Windowsç³»ç»Ÿ
            - 386 (32ä½) - é€‚ç”¨äº32ä½Windowsç³»ç»Ÿ

            ### ğŸš€ å¿«é€Ÿå®‰è£…

            **Linux ä¸€é”®å®‰è£…:**
            ```bash
            bash <(curl -Ls https://raw.githubusercontent.com/CNYuns/yun/main/install.sh)
            ```

            **æˆ–ä½¿ç”¨ Gitee é•œåƒ:**
            ```bash
            bash <(curl -Ls https://gitee.com/cnyuns/yun/raw/main/install.sh)
            ```

            **Windows:**
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ zip æ–‡ä»¶ï¼ˆ64ä½é€‰ amd64ï¼Œ32ä½é€‰ 386ï¼‰
            2. è§£å‹åè¿è¡Œ `yun.exe`

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [README.md](https://gitee.com/cnyuns/yun/blob/main/README.md) çš„ç‰ˆæœ¬æ›´æ–°ç« èŠ‚ã€‚

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - GitHub: https://github.com/CNYuns/yun
            - Gitee: https://gitee.com/cnyuns/yun
            - æ–‡æ¡£: https://gitee.com/cnyuns/yun/blob/main/README.md
