version: '1.0'
name: tag-release
displayName: Tagå‘å¸ƒæµæ°´çº¿

# ä»…åœ¨æ¨é€tagæ—¶è§¦å‘
triggers:
  push:
    tags:
      include:
        - v*.*.*

stages:
  # é˜¶æ®µ1ï¼šæ„å»º
  - stage:
      name: build
      displayName: ç¼–è¯‘æ„å»º
      steps:
        - step: build@golang
          name: build_releases
          displayName: Goç¼–è¯‘
          # Goç‰ˆæœ¬ï¼ˆGiteeæ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬ï¼‰
          golangVersion: '1.16'
          commands: |
            #!/bin/bash
            set -e

            echo "===== å¼€å§‹æ„å»º ====="
            echo "Go version:"
            go version

            # è¯»å–ç‰ˆæœ¬å·
            VERSION=$(cat config/version)
            echo "Building Yun Panel v$VERSION"

            # åˆ›å»ºè¾“å‡ºç›®å½•
            mkdir -p output

            # æ„å»ºLinux amd64
            echo "Building Linux amd64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-w -s" -o output/yun-linux-amd64 main.go

            # æ„å»ºLinux arm64
            echo "Building Linux arm64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-w -s" -o output/yun-linux-arm64 main.go

            # æ„å»ºLinux armv7
            echo "Building Linux armv7..."
            CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -ldflags "-w -s" -o output/yun-linux-armv7 main.go

            # æ„å»ºLinux 386
            echo "Building Linux 386..."
            CGO_ENABLED=0 GOOS=linux GOARCH=386 go build -ldflags "-w -s" -o output/yun-linux-386 main.go

            # æ„å»ºWindows amd64
            echo "Building Windows amd64..."
            CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags "-w -s" -o output/yun-windows-amd64.exe main.go

            echo "===== æ„å»ºå®Œæˆ ====="
            ls -lh output/

          # ä¿å­˜æ„å»ºäº§ç‰©
          artifacts:
            - name: BUILD_OUTPUT
              path:
                - ./output

  # é˜¶æ®µ2ï¼šæ‰“åŒ…
  - stage:
      name: package
      displayName: æ‰“åŒ…
      steps:
        - step: build@shell
          name: package_files
          displayName: æ‰“åŒ…æ–‡ä»¶
          # ä½¿ç”¨ä¸Šä¸€é˜¶æ®µçš„äº§ç‰©
          dependArtifact: BUILD_OUTPUT
          commands: |
            #!/bin/bash
            set -e

            echo "===== å¼€å§‹æ‰“åŒ… ====="

            cd output

            # æ‰“åŒ…Linux amd64
            echo "Packaging Linux amd64..."
            mkdir yun-linux-amd64-dir
            cp yun-linux-amd64 yun-linux-amd64-dir/yun
            cp ../yun.service yun-linux-amd64-dir/ || true
            cp ../yun.sh yun-linux-amd64-dir/ || true
            tar -czf yun-linux-amd64.tar.gz yun-linux-amd64-dir/
            rm -rf yun-linux-amd64-dir

            # æ‰“åŒ…Linux arm64
            echo "Packaging Linux arm64..."
            mkdir yun-linux-arm64-dir
            cp yun-linux-arm64 yun-linux-arm64-dir/yun
            cp ../yun.service yun-linux-arm64-dir/ || true
            cp ../yun.sh yun-linux-arm64-dir/ || true
            tar -czf yun-linux-arm64.tar.gz yun-linux-arm64-dir/
            rm -rf yun-linux-arm64-dir

            # æ‰“åŒ…Linux armv7
            echo "Packaging Linux armv7..."
            mkdir yun-linux-armv7-dir
            cp yun-linux-armv7 yun-linux-armv7-dir/yun
            cp ../yun.service yun-linux-armv7-dir/ || true
            cp ../yun.sh yun-linux-armv7-dir/ || true
            tar -czf yun-linux-armv7.tar.gz yun-linux-armv7-dir/
            rm -rf yun-linux-armv7-dir

            # æ‰“åŒ…Linux 386
            echo "Packaging Linux 386..."
            mkdir yun-linux-386-dir
            cp yun-linux-386 yun-linux-386-dir/yun
            cp ../yun.service yun-linux-386-dir/ || true
            cp ../yun.sh yun-linux-386-dir/ || true
            tar -czf yun-linux-386.tar.gz yun-linux-386-dir/
            rm -rf yun-linux-386-dir

            # æ‰“åŒ…Windows amd64
            echo "Packaging Windows amd64..."
            mkdir yun-windows-amd64-dir
            cp yun-windows-amd64.exe yun-windows-amd64-dir/yun.exe
            zip -r yun-windows-amd64.zip yun-windows-amd64-dir/
            rm -rf yun-windows-amd64-dir

            echo "===== æ‰“åŒ…å®Œæˆ ====="
            ls -lh *.tar.gz *.zip

          artifacts:
            - name: RELEASE_PACKAGES
              path:
                - ./output/*.tar.gz
                - ./output/*.zip

  # é˜¶æ®µ3ï¼šä¸Šä¼ åˆ°Release
  - stage:
      name: release
      displayName: å‘å¸ƒRelease
      steps:
        - step: publish@release_artifacts
          name: upload_release
          displayName: ä¸Šä¼ Releaseæ–‡ä»¶
          # ä½¿ç”¨æ‰“åŒ…é˜¶æ®µçš„äº§ç‰©
          dependArtifact: RELEASE_PACKAGES
          # ä½¿ç”¨Gitæ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
          version: '${GIT_TAG}'
          # Releaseè¯´æ˜
          releaseNote: |
            ## Yun Panel ${GIT_TAG}

            è‡ªåŠ¨æ„å»ºçš„å¤šå¹³å°å‘å¸ƒç‰ˆæœ¬ã€‚

            ### ğŸ“¦ æ”¯æŒçš„å¹³å°

            - **Linux**: amd64, arm64, armv7, 386
            - **Windows**: amd64

            ### ğŸš€ å¿«é€Ÿå®‰è£…

            **Linux ä¸€é”®å®‰è£…:**
            ```bash
            bash <(curl -Ls https://raw.githubusercontent.com/CNYuns/yun/main/install.sh)
            ```

            **æˆ–ä½¿ç”¨ Gitee é•œåƒ:**
            ```bash
            bash <(curl -Ls https://gitee.com/cnyuns/yun/raw/main/install.sh)
            ```

            **Windows:**
            1. ä¸‹è½½ `yun-windows-amd64.zip`
            2. è§£å‹åè¿è¡Œ `yun.exe`

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [README.md](https://github.com/CNYuns/yun/blob/main/README.md) çš„ç‰ˆæœ¬æ›´æ–°ç« èŠ‚ã€‚

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - GitHub: https://github.com/CNYuns/yun
            - Gitee: https://gitee.com/cnyuns/yun
            - æ–‡æ¡£: https://github.com/CNYuns/yun/blob/main/README.md
