version: '1.0'
name: tag-release
displayName: Tagå‘å¸ƒæµæ°´çº¿

# ä»…åœ¨æ¨é€tagæ—¶è§¦å‘
triggers:
  push:
    tags:
      include:
        - v*.*.*

stages:
  # é˜¶æ®µ1ï¼šæ„å»º
  - stage:
      name: build
      displayName: ç¼–è¯‘æ„å»º
      steps:
        - step: build@golang
          name: build_releases
          displayName: Goç¼–è¯‘
          # Goç‰ˆæœ¬ï¼ˆä½¿ç”¨1.21ä»¥ä¸Šï¼‰
          golangVersion: '1.21'
          commands: |
            #!/bin/bash
            set -e

            echo "===== é…ç½®Goç¯å¢ƒ ====="
            # å¼ºåˆ¶ä½¿ç”¨å›½å†…é•œåƒï¼Œç¦æ­¢ç›´è¿
            export GOPROXY=https://goproxy.cn,https://goproxy.io
            export GOSUMDB=sum.golang.google.cn
            export GO111MODULE=on
            export GOTOOLCHAIN=local
            export GONOPROXY=""
            export GONOSUMDB=""
            export GOPRIVATE=""

            echo "Go version:"
            go version
            echo "GOPROXY: $GOPROXY"

            # è¯»å–ç‰ˆæœ¬å·
            VERSION=$(cat config/version | tr -d '\n\r')
            echo "Building Yun Panel v$VERSION"

            # åˆ›å»ºè¾“å‡ºç›®å½•
            mkdir -p output

            echo "===== å¼€å§‹æ„å»º ====="

            # æ„å»ºLinux amd64ï¼ˆæœ€å¸¸ç”¨ï¼‰
            echo "Building Linux amd64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=readonly -ldflags "-w -s" -trimpath -o output/yun-linux-amd64 main.go

            # æ„å»ºLinux arm64ï¼ˆARMæœåŠ¡å™¨ï¼‰
            echo "Building Linux arm64..."
            CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -mod=readonly -ldflags "-w -s" -trimpath -o output/yun-linux-arm64 main.go

            # æ„å»ºWindows amd64ï¼ˆ64ä½ï¼‰
            echo "Building Windows amd64..."
            CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -mod=readonly -ldflags "-w -s" -trimpath -o output/yun-windows-amd64.exe main.go

            # æ„å»ºWindows 386ï¼ˆ32ä½ï¼‰
            echo "Building Windows 386..."
            CGO_ENABLED=0 GOOS=windows GOARCH=386 go build -mod=readonly -ldflags "-w -s" -trimpath -o output/yun-windows-386.exe main.go

            echo "===== æ„å»ºå®Œæˆ ====="
            ls -lh output/

          # ä¿å­˜æ„å»ºäº§ç‰©
          artifacts:
            - name: BUILD_OUTPUT
              path:
                - ./output

  # é˜¶æ®µ2ï¼šæ‰“åŒ…
  - stage:
      name: package
      displayName: æ‰“åŒ…
      steps:
        - step: build@shell
          name: package_files
          displayName: æ‰“åŒ…æ–‡ä»¶
          # ä½¿ç”¨ä¸Šä¸€é˜¶æ®µçš„äº§ç‰©
          dependArtifact: BUILD_OUTPUT
          commands: |
            #!/bin/bash
            set -e

            echo "===== å¼€å§‹æ‰“åŒ… ====="

            cd output

            # æ‰“åŒ…Linux amd64
            echo "Packaging Linux amd64..."
            mkdir yun-linux-amd64-dir
            cp yun-linux-amd64 yun-linux-amd64-dir/yun
            cp ../yun.service yun-linux-amd64-dir/ || true
            cp ../yun.sh yun-linux-amd64-dir/ || true
            tar -czf yun-linux-amd64.tar.gz yun-linux-amd64-dir/
            rm -rf yun-linux-amd64-dir

            # æ‰“åŒ…Linux arm64
            echo "Packaging Linux arm64..."
            mkdir yun-linux-arm64-dir
            cp yun-linux-arm64 yun-linux-arm64-dir/yun
            cp ../yun.service yun-linux-arm64-dir/ || true
            cp ../yun.sh yun-linux-arm64-dir/ || true
            tar -czf yun-linux-arm64.tar.gz yun-linux-arm64-dir/
            rm -rf yun-linux-arm64-dir

            # æ‰“åŒ…Windows amd64
            echo "Packaging Windows amd64..."
            mkdir yun-windows-amd64-dir
            cp yun-windows-amd64.exe yun-windows-amd64-dir/yun.exe
            zip -r yun-windows-amd64.zip yun-windows-amd64-dir/
            rm -rf yun-windows-amd64-dir

            # æ‰“åŒ…Windows 386
            echo "Packaging Windows 386..."
            mkdir yun-windows-386-dir
            cp yun-windows-386.exe yun-windows-386-dir/yun.exe
            zip -r yun-windows-386.zip yun-windows-386-dir/
            rm -rf yun-windows-386-dir

            echo "===== æ‰“åŒ…å®Œæˆ ====="
            ls -lh *.tar.gz *.zip

          artifacts:
            - name: RELEASE_PACKAGES
              path:
                - ./output/*.tar.gz
                - ./output/*.zip

  # é˜¶æ®µ3ï¼šä¸Šä¼ åˆ°Release
  - stage:
      name: release
      displayName: å‘å¸ƒRelease
      steps:
        - step: publish@release_artifacts
          name: upload_release
          displayName: ä¸Šä¼ Releaseæ–‡ä»¶
          # ä½¿ç”¨æ‰“åŒ…é˜¶æ®µçš„äº§ç‰©
          dependArtifact: RELEASE_PACKAGES
          # ä½¿ç”¨Gitæ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
          version: '${GIT_TAG}'
          # Releaseè¯´æ˜
          releaseNote: |
            ## Yun Panel ${GIT_TAG}

            è‡ªåŠ¨æ„å»ºçš„å¤šå¹³å°å‘å¸ƒç‰ˆæœ¬ã€‚

            ### ğŸ“¦ æ”¯æŒçš„å¹³å°

            **Linux:**
            - amd64 (x86_64) - é€‚ç”¨äºå¤§å¤šæ•°LinuxæœåŠ¡å™¨
            - arm64 (aarch64) - é€‚ç”¨äºARMæ¶æ„æœåŠ¡å™¨

            **Windows:**
            - amd64 (64ä½) - é€‚ç”¨äº64ä½Windowsç³»ç»Ÿ
            - 386 (32ä½) - é€‚ç”¨äº32ä½Windowsç³»ç»Ÿ

            ### ğŸš€ å¿«é€Ÿå®‰è£…

            **Linux ä¸€é”®å®‰è£…:**
            ```bash
            bash <(curl -Ls https://raw.githubusercontent.com/CNYuns/yun/main/install.sh)
            ```

            **æˆ–ä½¿ç”¨ Gitee é•œåƒ:**
            ```bash
            bash <(curl -Ls https://gitee.com/cnyuns/yun/raw/main/install.sh)
            ```

            **Windows:**
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ zip æ–‡ä»¶ï¼ˆ64ä½é€‰ amd64ï¼Œ32ä½é€‰ 386ï¼‰
            2. è§£å‹åè¿è¡Œ `yun.exe`

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [README.md](https://github.com/CNYuns/yun/blob/main/README.md) çš„ç‰ˆæœ¬æ›´æ–°ç« èŠ‚ã€‚

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - GitHub: https://github.com/CNYuns/yun
            - Gitee: https://gitee.com/cnyuns/yun
            - æ–‡æ¡£: https://github.com/CNYuns/yun/blob/main/README.md
